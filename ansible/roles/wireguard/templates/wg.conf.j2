# {{ ansible_managed }}
# WireGuard configuration for {{ inventory_hostname }}
# Role: {{ wg_role }}

[Interface]
Address = {{ wg_address }}
PrivateKey = {{ wg_private_key }}
{% if wg_listen_port is defined %}
ListenPort = {{ wg_listen_port }}
{% endif %}

# NAT/Masquerade for forwarding traffic
PostUp = iptables -t nat -A POSTROUTING -o $(ip route | awk '/default/ {print $5; exit}') -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -o $(ip route | awk '/default/ {print $5; exit}') -j MASQUERADE

{% if wg_role == 'internal' %}
# Internal node needs additional rules to maintain external SSH access
PostUp = ip rule add from $(ip addr show $(ip route | awk '/default/ { print $5 }') | grep "inet" | grep -v "inet6" | head -n 1 | awk '/inet/ {print $2}' | awk -F/ '{print $1}') table main
PostDown = ip rule del from $(ip addr show $(ip route | awk '/default/ { print $5 }') | grep "inet" | grep -v "inet6" | head -n 1 | awk '/inet/ {print $2}' | awk -F/ '{print $1}') table main

# Direct routes for Telegram API and DNS â€” bypasses WireGuard tunnel
# iif lo = only locally-originated traffic (not forwarded from VPN clients)
PostUp = ip route add default via $(ip route show table main default | awk '{print $3}') dev $(ip route show table main default | awk '{print $5}') table 200 2>/dev/null || true
PostUp = ip rule add to 149.154.160.0/20 iif lo table 200 priority 100 2>/dev/null || true
PostUp = ip rule add to 91.108.4.0/22 iif lo table 200 priority 100 2>/dev/null || true
PostUp = ip rule add to 8.8.8.8/32 iif lo table 200 priority 100 2>/dev/null || true
PostUp = ip rule add to 8.8.4.4/32 iif lo table 200 priority 100 2>/dev/null || true
PostDown = ip rule del to 149.154.160.0/20 iif lo table 200 priority 100 2>/dev/null || true
PostDown = ip rule del to 91.108.4.0/22 iif lo table 200 priority 100 2>/dev/null || true
PostDown = ip rule del to 8.8.8.8/32 iif lo table 200 priority 100 2>/dev/null || true
PostDown = ip rule del to 8.8.4.4/32 iif lo table 200 priority 100 2>/dev/null || true
PostDown = ip route flush table 200 2>/dev/null || true
{% endif %}

{% for peer_name in groups['vpn'] %}
{% if peer_name != inventory_hostname %}
{% set peer_vars = hostvars[peer_name] %}
# Peer: {{ peer_name }} ({{ peer_vars.wg_role }})
[Peer]
PublicKey = {{ peer_vars.wg_public_key }}
{% if wg_role == 'internal' and peer_vars.wg_role == 'external' %}
# Internal -> External: route all traffic through external node
AllowedIPs = {{ peer_vars.wg_address | regex_replace('/\\d+$', '/32') }}, 0.0.0.0/0
Endpoint = {{ peer_vars.ansible_host }}:{{ peer_vars.wg_listen_port | default(wg_default_listen_port) }}
{% elif wg_role == 'external' and peer_vars.wg_role == 'internal' %}
# External -> Internal: allow traffic from internal network
AllowedIPs = {{ wg_network }}
Endpoint = {{ peer_vars.wg_endpoint }}:{{ peer_vars.wg_endpoint_port | default(wg_default_listen_port) }}
PersistentKeepalive = {{ wg_persistent_keepalive }}
{% else %}
# Default peer configuration
AllowedIPs = {{ peer_vars.wg_address | regex_replace('/\\d+$', '/32') }}
{% if peer_vars.wg_endpoint is defined %}
Endpoint = {{ peer_vars.wg_endpoint }}:{{ peer_vars.wg_endpoint_port | default(wg_default_listen_port) }}
{% endif %}
{% if wg_persistent_keepalive is defined %}
PersistentKeepalive = {{ wg_persistent_keepalive }}
{% endif %}
{% endif %}

{% endif %}
{% endfor %}
